<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Goals V2.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --primary-soft: #e0e7ff;
            --bg-color: #f8fafc;
            --text-main: #1e293b;
            --text-light: #64748b;
            --accent: #f43f5e;
            --success: #10b981;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius-pill: 50px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            height: 100vh; overflow: hidden;
        }

        .hidden { display: none !important; }
        .hidden-view { display: none !important; }

        /* Ïä§ÌîåÎûòÏãú & Î°úÍ∑∏Ïù∏ */
        #splash-screen {
            position: fixed; inset: 0; background: white;
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .logo-circle { font-size: 4rem; margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #splash-screen h1 { text-align: center; margin: 0; line-height: 1.2; color: var(--text-main); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 5000;
        }
        .modal-content {
            background: white; width: 85%; max-width: 360px; padding: 30px;
            border-radius: 24px; text-align: center; box-shadow: var(--shadow-md);
        }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .login-btn {
            padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; background: white;
            font-weight: 500; cursor: pointer; color: var(--text-main);
        }
        .login-btn.taken { background: var(--primary-soft); color: var(--primary); border: none; font-weight: 700; }

        #app-container { display: flex; flex-direction: column; height: 100%; }
        .glass-header {
            padding: 15px 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 10; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .round-btn {
            width: 36px; height: 36px; border-radius: 50%; background: white; border: 1px solid #e2e8f0;
            margin-left: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
        #main-content {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: 200px; /* Ïä§ÌÅ¨Î°§ Ïó¨Ïú† Í≥µÍ∞Ñ */
        }

        /* Ïª¥Ìè¨ÎÑåÌä∏ */
        .verse-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 20px; margin-bottom: 25px;
            box-shadow: 0 10px 15px -3px rgba(118, 75, 162, 0.3);
        }
        .verse-badge { font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; display: inline-block; font-weight: 700; margin-bottom: 10px; }
        #verse-text { font-size: 1rem; line-height: 1.6; margin: 0; font-weight: 500; }
        #verse-ref { text-align: right; font-size: 0.8rem; margin-top: 8px; opacity: 0.8; }

        .input-pill {
            background: white; border-radius: var(--radius-pill); padding: 5px 5px 5px 20px;
            display: flex; align-items: center; box-shadow: var(--shadow-sm); margin-bottom: 20px; border: 1px solid #e2e8f0;
        }
        .input-pill input { flex: 1; border: none; font-size: 0.95rem; background: transparent; }
        .add-circle-btn {
            width: 42px; height: 42px; border-radius: 50%; background: var(--primary); color: white;
            border: none; font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .input-pill.small { padding: 4px 4px 4px 15px; margin-top: 10px; }
        .send-btn { background: var(--text-main); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }

        .resolution-item {
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-sm);
        }
        .res-left { flex: 1; }
        .res-text { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 8px; }
        .steps { display: flex; gap: 6px; flex-wrap: wrap; }
        .step-item {
            background: #f1f5f9; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; color: var(--text-light); cursor: pointer;
        }
        .step-item.done { background: var(--primary); color: white; }
        .del-icon-btn { background: none; border: none; color: #cbd5e1; font-size: 1rem; padding: 10px; cursor: pointer; }

        .chat-container { background: white; padding: 15px; border-radius: 20px; box-shadow: var(--shadow-sm); }
        #msg-list li { font-size: 0.85rem; margin-bottom: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
        #msg-list li b { color: var(--primary); margin-right: 5px; }

        /* ÏÑ±Í≤Ω */
        .bible-stat-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .bible-stat-box {
            flex: 1; background: white; padding: 15px; border-radius: 16px; text-align: center;
            box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;
        }
        .bs-label { font-size: 0.75rem; color: var(--text-light); display: block; margin-bottom: 5px; }
        .bs-val { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .bs-val.today { color: var(--accent); }

        .bible-card {
            display: flex; align-items: center; padding: 20px; border-radius: 20px; margin-bottom: 12px; cursor: pointer;
            background: white; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0;
        }
        .bible-card.old .card-icon { background: #fff7ed; }
        .bible-card.new .card-icon { background: #f5f3ff; }
        .card-icon { font-size: 2rem; margin-right: 15px; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .card-text h3 { margin: 0; font-size: 1.1rem; }
        .card-text p { margin: 2px 0 0 0; color: var(--text-light); font-size: 0.85rem; }

        .grid-books { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .bible-btn { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px 0; text-align: center; font-size: 0.9rem; cursor: pointer; }
        .bible-btn.completed { background: #ecfccb; border-color: #84cc16; color: #3f6212; font-weight: 700; }

        .chapter-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .chapter-tools { display: flex; gap: 10px; }
        .text-btn { background: #f1f5f9; border: none; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; color: var(--text-light); }

        .finish-pill-btn {
            width: 100%; background: var(--text-main); color: white; border: none; padding: 12px; border-radius: 16px;
            font-size: 1rem; margin-bottom: 20px; cursor: pointer; transition: all 0.3s;
        }
        .finish-pill-btn.disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }

        .grid-chapters { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .chapter-item { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 0; text-align: center; cursor: pointer; font-size: 0.9rem; }
        .chapter-item.checked { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

        /* ÌÜµÍ≥Ñ & Í∏∞Í∞Ñ */
        .period-card {
            background: linear-gradient(135deg, #4f46e5, #ec4899);
            color: white; padding: 20px; border-radius: 20px; margin-bottom: 25px;
            text-align: center; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
        }
        .period-label { font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px; }
        .period-date { font-size: 1.1rem; font-weight: 700; }

        .section-header { margin-bottom: 15px; margin-top: 30px; }
        .section-header:first-child { margin-top: 0; }
        .section-header .title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
        
        .stat-card { background: white; border-radius: 20px; padding: 20px; box-shadow: var(--shadow-sm); margin-bottom: 20px; }
        
        /* Ìï≠Î™©Î≥Ñ ÏÑ±Ï∑®ÎèÑ Í∑∏ÎûòÌîÑ */
        .goal-stat-item { margin-bottom: 12px; }
        .goal-label-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; }
        .goal-name { font-weight: 600; color: var(--text-main); }
        .goal-percent { color: var(--primary); font-weight: 700; }
        .progress-bg { width: 100%; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); border-radius: 4px; }

        /* ÌûàÌä∏Îßµ */
        .heatmap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .heat-day { aspect-ratio: 1; border-radius: 6px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #cbd5e1; transition: all 0.3s; }
        .heat-day.level-1 { background: #c7d2fe; color: var(--primary); }
        .heat-day.level-2 { background: #818cf8; color: white; }
        .heat-day.level-3 { background: #4338ca; color: white; font-weight: bold; }
        .heat-day.today { border: 2px solid var(--accent); }

        .ranking-container { display: flex; gap: 15px; margin-bottom: 20px; }
        .ranking-box { flex: 1; background: white; border-radius: 16px; padding: 15px; box-shadow: var(--shadow-sm); }
        .ranking-title { font-size: 0.9rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .rank-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; }
        .rank-row .score { font-weight: 700; color: var(--primary); }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 80px; background: rgba(255,255,255,0.95);
            display: flex; justify-content: space-around; padding-bottom: 20px; border-top: 1px solid rgba(0,0,0,0.05); z-index: 100;
        }
        .nav-item { background: none; border: none; color: #94a3b8; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .nav-item.active { color: var(--primary); }
        .nav-item .icon { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item .label { font-size: 0.7rem; font-weight: 600; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <div class="logo-circle">‚õ™Ô∏è</div>
            <h1>FAMILY<br>GOALS</h1>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome</h2>
                <p>Í∞ÄÏ°± Íµ¨ÏÑ±ÏõêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
            </div>
            <div id="login-grid" class="grid-container"></div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
        <header class="glass-header">
            <div class="header-content">
                <span class="greeting">Hi, <b id="user-name">User</b></span>
                <div class="header-actions">
                    <button class="icon-btn round-btn" onclick="window.saveAlarmTime()">üîî</button>
                    <button class="icon-btn round-btn" onclick="window.logoutAction()">üö™</button>
                </div>
            </div>
        </header>

        <main id="main-content">
            
            <div class="verse-card">
                <div class="verse-badge">Ïò§ÎäòÏùò ÎßêÏîÄ</div>
                <p id="verse-text">Loading...</p>
                <p id="verse-ref"></p>
            </div>

            <div id="page-resolution" class="page active">
                <div class="section-header">
                    <span class="title">My Goals</span>
                </div>
                
                <div class="input-pill">
                    <input type="text" id="input-resolution" placeholder="Î™©Ìëú ÏûÖÎ†• (Ïòà: Îß§Ïùº Ïö¥Îèô)">
                    <button onclick="window.addItem()" class="add-circle-btn">+</button>
                </div>
                
                <ul id="list-resolution"></ul>
                
                <div class="section-header">
                    <span class="title">Family Chat</span>
                </div>
                <div class="chat-container">
                    <ul id="msg-list"></ul>
                    <div class="input-pill small">
                        <input type="text" id="input-msg" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•...">
                        <button onclick="window.sendMsg()" class="send-btn">Ï†ÑÏÜ°</button>
                    </div>
                </div>
            </div>

            <div id="page-bible" class="page hidden">
                <div class="bible-stat-row">
                    <div class="bible-stat-box">
                        <span class="bs-label">Ïò§Îäò ÏùΩÏùå</span>
                        <span class="bs-val today" id="bible-today-count">0Ïû•</span>
                    </div>
                    <div class="bible-stat-box">
                        <span class="bs-label">Ïò¨Ìï¥ ÎàÑÏ†Å</span>
                        <span class="bs-val" id="bible-year-count">0Ïû•</span>
                    </div>
                </div>

                <div id="bible-main-view">
                    <div class="bible-card old" onclick="window.showBibleBooks('old')">
                        <div class="card-icon">üìú</div>
                        <div class="card-text">
                            <h3>Íµ¨ÏïΩ (Old)</h3>
                            <p>39Í∂å</p>
                        </div>
                    </div>
                    <div class="bible-card new" onclick="window.showBibleBooks('new')">
                        <div class="card-icon">‚úùÔ∏è</div>
                        <div class="card-text">
                            <h3>Ïã†ÏïΩ (New)</h3>
                            <p>27Í∂å</p>
                        </div>
                    </div>
                </div>

                <div id="bible-books-view" class="hidden-view">
                    <button class="nav-back-btn" onclick="window.showBibleMain()">
                        <i class="fas fa-chevron-left"></i> Îí§Î°ú
                    </button>
                    <h3 id="bible-testament-title" class="section-header title" style="margin-bottom:15px;"></h3>
                    <div id="bible-books-grid" class="grid-books"></div>
                </div>

                <div id="bible-chapters-view" class="hidden-view">
                    <button class="nav-back-btn" onclick="window.backToBooks()">
                        <i class="fas fa-chevron-left"></i> Î™©Î°ù
                    </button>
                    
                    <div class="chapter-header-row">
                        <h3 id="bible-book-title" class="section-header title" style="margin:0;"></h3>
                        <div class="chapter-tools">
                            <button class="text-btn" onclick="window.controlAll(true)">Ï†ÑÏ≤¥ÏÑ†ÌÉù</button>
                            <button class="text-btn" onclick="window.controlAll(false)">Ìï¥Ï†ú</button>
                        </div>
                    </div>
                    
                    <button id="btn-finish-book" onclick="window.finishBookAndReset()" class="finish-pill-btn disabled">
                        Ïù¥ Ï±Ö ÏôÑÎèÖÌïòÍ∏∞ üéâ
                    </button>

                    <div id="bible-chapters-grid" class="grid-chapters"></div>
                </div>
            </div>

            <div id="page-stats" class="page hidden">
                
                <div class="period-card" onclick="window.setPeriod()">
                    <div class="period-label">üèÜ Í≤∞Îã®ÏÑú ÏãúÏ¶å (ÌÑ∞ÏπòÌïòÏó¨ ÏÑ§Ï†ï)</div>
                    <div class="period-date" id="period-display">ÏÑ§Ï†ï ÌïÑÏöî</div>
                </div>

                <div class="section-header">
                    <span class="title">Í∞ÄÏ°± Îû≠ÌÇπ (Top Priority)</span>
                </div>
                <div class="ranking-container">
                    <div class="ranking-box">
                        <div class="ranking-title">üìù Í≤∞Îã®ÏÑú (ÏãúÏ¶å)</div>
                        <div id="rank-resolution"></div>
                    </div>
                    <div class="ranking-box">
                        <div class="ranking-title">üìñ ÏÑ±Í≤Ω (Ïù¥Î≤àÏ£º)</div>
                        <div id="rank-bible"></div>
                    </div>
                </div>

                <div class="section-header">
                    <span class="title">Î™©ÌëúÎ≥Ñ Îã¨ÏÑ±ÎèÑ</span>
                </div>
                <div class="stat-card" id="goal-breakdown-list"></div>

                <div class="section-header">
                    <span class="title">Ïù¥Î≤à Îã¨ ÌôúÎèô (Heatmap)</span>
                </div>
                <div class="stat-card">
                    <div id="heatmap-grid" class="heatmap"></div>
                </div>

            </div>

        </main>

        <nav class="bottom-nav glass-nav">
            <button class="nav-item active" onclick="window.goTab('resolution', this)">
                <i class="fas fa-list-check icon"></i>
                <span class="label">Î™©Ìëú</span>
            </button>
            <button class="nav-item" onclick="window.goTab('bible', this)">
                <i class="fas fa-book-open icon"></i>
                <span class="label">ÏÑ±Í≤Ω</span>
            </button>
            <button class="nav-item" onclick="window.goTab('stats', this)">
                <i class="fas fa-chart-simple icon"></i>
                <span class="label">ÏàúÏúÑ</span>
            </button>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº
        // Ïó¨Í∏∞Ïóê Config Î∂ôÏó¨ÎÑ£Í∏∞ (ÌïÑÏàò!)
        // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤
        const firebaseConfig = {
            apiKey: "AIzaSyD0Vorv3SFatQuC7OCYHPA-Nok4DlqonrI",
authDomain: "family-resolution.firebaseapp.com",
projectId: "family-resolution",
storageBucket: "family-resolution.firebasestorage.app",
messagingSenderId: "711396068080",
appId: "1:711396068080:web:861c41a8259f0b6dca9035",
measurementId: "G-RH6E87B4H0"
};

        const BIBLE_DATA = {
            "books": [
                { "name": "Ï∞ΩÏÑ∏Í∏∞", "chapters": 50, "testament": "old" }, { "name": "Ï∂úÏï†ÍµΩÍ∏∞", "chapters": 40, "testament": "old" },
                { "name": "Î†àÏúÑÍ∏∞", "chapters": 27, "testament": "old" }, { "name": "ÎØºÏàòÍ∏∞", "chapters": 36, "testament": "old" },
                { "name": "Ïã†Î™ÖÍ∏∞", "chapters": 34, "testament": "old" }, { "name": "Ïó¨Ìò∏ÏàòÏïÑ", "chapters": 24, "testament": "old" },
                { "name": "ÏÇ¨ÏÇ¨Í∏∞", "chapters": 21, "testament": "old" }, { "name": "Î£ªÍ∏∞", "chapters": 4, "testament": "old" },
                { "name": "ÏÇ¨Î¨¥ÏóòÏÉÅ", "chapters": 31, "testament": "old" }, { "name": "ÏÇ¨Î¨¥ÏóòÌïò", "chapters": 24, "testament": "old" },
                { "name": "Ïó¥ÏôïÍ∏∞ÏÉÅ", "chapters": 22, "testament": "old" }, { "name": "Ïó¥ÏôïÍ∏∞Ìïò", "chapters": 25, "testament": "old" },
                { "name": "Ïó≠ÎåÄÏÉÅ", "chapters": 29, "testament": "old" }, { "name": "Ïó≠ÎåÄÌïò", "chapters": 36, "testament": "old" },
                { "name": "ÏóêÏä§Îùº", "chapters": 10, "testament": "old" }, { "name": "ÎäêÌó§ÎØ∏Ïïº", "chapters": 13, "testament": "old" },
                { "name": "ÏóêÏä§Îçî", "chapters": 10, "testament": "old" }, { "name": "Ïö•Í∏∞", "chapters": 42, "testament": "old" },
                { "name": "ÏãúÌé∏", "chapters": 150, "testament": "old" }, { "name": "Ïû†Ïñ∏", "chapters": 31, "testament": "old" },
                { "name": "Ï†ÑÎèÑÏÑú", "chapters": 12, "testament": "old" }, { "name": "ÏïÑÍ∞Ä", "chapters": 8, "testament": "old" },
                { "name": "Ïù¥ÏÇ¨Ïïº", "chapters": 66, "testament": "old" }, { "name": "ÏòàÎ†àÎØ∏Ïïº", "chapters": 52, "testament": "old" },
                { "name": "ÏòàÎ†àÎØ∏ÏïºÏï†Í∞Ä", "chapters": 5, "testament": "old" }, { "name": "ÏóêÏä§Í≤î", "chapters": 48, "testament": "old" },
                { "name": "Îã§ÎãàÏóò", "chapters": 12, "testament": "old" }, { "name": "Ìò∏ÏÑ∏ÏïÑ", "chapters": 14, "testament": "old" },
                { "name": "ÏöîÏóò", "chapters": 3, "testament": "old" }, { "name": "ÏïÑÎ™®Ïä§", "chapters": 9, "testament": "old" },
                { "name": "Ïò§Î∞îÎåú", "chapters": 1, "testament": "old" }, { "name": "ÏöîÎÇò", "chapters": 4, "testament": "old" },
                { "name": "ÎØ∏Í∞Ä", "chapters": 7, "testament": "old" }, { "name": "ÎÇòÌõî", "chapters": 3, "testament": "old" },
                { "name": "ÌïòÎ∞ïÍµ≠", "chapters": 3, "testament": "old" }, { "name": "Ïä§Î∞îÎÉê", "chapters": 3, "testament": "old" },
                { "name": "ÌïôÍ∞ú", "chapters": 2, "testament": "old" }, { "name": "Ïä§Í∞ÄÎû¥", "chapters": 14, "testament": "old" },
                { "name": "ÎßêÎùºÍ∏∞", "chapters": 4, "testament": "old" }, { "name": "ÎßàÌÉúÎ≥µÏùå", "chapters": 28, "testament": "new" },
                { "name": "ÎßàÍ∞ÄÎ≥µÏùå", "chapters": 16, "testament": "new" }, { "name": "ÎàÑÍ∞ÄÎ≥µÏùå", "chapters": 24, "testament": "new" },
                { "name": "ÏöîÌïúÎ≥µÏùå", "chapters": 21, "testament": "new" }, { "name": "ÏÇ¨ÎèÑÌñâÏ†Ñ", "chapters": 28, "testament": "new" },
                { "name": "Î°úÎßàÏÑú", "chapters": 16, "testament": "new" }, { "name": "Í≥†Î¶∞ÎèÑÏ†ÑÏÑú", "chapters": 16, "testament": "new" },
                { "name": "Í≥†Î¶∞ÎèÑÌõÑÏÑú", "chapters": 13, "testament": "new" }, { "name": "Í∞àÎùºÎîîÏïÑÏÑú", "chapters": 6, "testament": "new" },
                { "name": "ÏóêÎ≤†ÏÜåÏÑú", "chapters": 6, "testament": "new" }, { "name": "ÎπåÎ¶ΩÎ≥¥ÏÑú", "chapters": 4, "testament": "new" },
                { "name": "Í≥®Î°úÏÉàÏÑú", "chapters": 4, "testament": "new" }, { "name": "Îç∞ÏÇ¥Î°úÎãàÍ∞ÄÏ†ÑÏÑú", "chapters": 5, "testament": "new" },
                { "name": "Îç∞ÏÇ¥Î°úÎãàÍ∞ÄÌõÑÏÑú", "chapters": 3, "testament": "new" }, { "name": "ÎîîÎ™®Îç∞Ï†ÑÏÑú", "chapters": 6, "testament": "new" },
                { "name": "ÎîîÎ™®Îç∞ÌõÑÏÑú", "chapters": 4, "testament": "new" }, { "name": "ÎîîÎèÑÏÑú", "chapters": 3, "testament": "new" },
                { "name": "ÎπåÎ†àÎ™¨ÏÑú", "chapters": 1, "testament": "new" }, { "name": "ÌûàÎ∏åÎ¶¨ÏÑú", "chapters": 13, "testament": "new" },
                { "name": "ÏïºÍ≥†Î≥¥ÏÑú", "chapters": 5, "testament": "new" }, { "name": "Î≤†ÎìúÎ°úÏ†ÑÏÑú", "chapters": 5, "testament": "new" },
                { "name": "Î≤†ÎìúÎ°úÌõÑÏÑú", "chapters": 3, "testament": "new" }, { "name": "ÏöîÌïú1ÏÑú", "chapters": 5, "testament": "new" },
                { "name": "ÏöîÌïú2ÏÑú", "chapters": 1, "testament": "new" }, { "name": "ÏöîÌïú3ÏÑú", "chapters": 1, "testament": "new" },
                { "name": "Ïú†Îã§ÏÑú", "chapters": 1, "testament": "new" }, { "name": "ÏöîÌïúÍ≥ÑÏãúÎ°ù", "chapters": 22, "testament": "new" }
            ]
        };
        const USER_SLOTS = ["user_1", "user_2", "user_3", "user_4", "user_5", "user_6"];

        let app, db, docRef;
        let appData = {};
        let bibleState = { currentTestament: null, currentBook: null };
        let myName = localStorage.getItem('myId');

        async function startApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                docRef = doc(db, "appData", "familyDataV28_Secure");

                onSnapshot(docRef, (snapshot) => {
                    document.getElementById('splash-screen').style.opacity = '0';
                    setTimeout(()=> document.getElementById('splash-screen').style.display='none', 500);

                    if(snapshot.exists()) {
                        const data = snapshot.data();
                        appData = data.appData ? data.appData : data;
                        if(!appData.auth) appData.auth = {};
                        if(!appData.period) {
                            const y = new Date().getFullYear();
                            appData.period = { start: `${y}-01-01`, end: `${y}-12-31` };
                        }
                        
                        USER_SLOTS.forEach(slot => {
                            if(!appData[slot]) appData[slot] = { resolution: [], bible: {}, history: {}, bibleRounds: {} };
                        });
                        checkLoginStatus();
                    } else {
                        initNewData();
                    }
                });

                const verses = [
                    { t: "ÎÇ¥Í≤å Îä•Î†• Ï£ºÏãúÎäî Ïûê ÏïàÏóêÏÑú ÎÇ¥Í∞Ä Î™®Îì† Í≤ÉÏùÑ Ìï† Ïàò ÏûàÎäêÎãàÎùº", r: "ÎπåÎ¶ΩÎ≥¥ÏÑú 4:13" },
                    { t: "Ïó¨Ìò∏ÏôÄÎäî ÎÇòÏùò Î™©ÏûêÏãúÎãà ÎÇ¥Í≤å Î∂ÄÏ°±Ìï®Ïù¥ ÏóÜÏúºÎ¶¨Î°úÎã§", r: "ÏãúÌé∏ 23:1" },
                    { t: "ÎÑàÏùò ÌñâÏÇ¨Î•º Ïó¨Ìò∏ÏôÄÍªò Îß°Í∏∞Îùº Í∑∏Î¶¨ÌïòÎ©¥ ÎÑ§Í∞Ä Í≤ΩÏòÅÌïòÎäî Í≤ÉÏù¥ Ïù¥Î£®Ïñ¥ÏßÄÎ¶¨Îùº", r: "Ïû†Ïñ∏ 16:3" }
                ];
                const v = verses[Math.floor(Math.random()*verses.length)];
                document.getElementById('verse-text').innerText = v.t;
                document.getElementById('verse-ref').innerText = v.r;
            } catch (e) { alert("Config Ïò§Î•ò! ÏΩîÎìúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî."); }
        }

        function checkLoginStatus() {
            const modal = document.getElementById('login-modal');
            const container = document.getElementById('app-container');
            
            if(myName && appData.auth[myName]) {
                if(modal) modal.classList.add('hidden');
                if(container) container.classList.remove('hidden');
                updateMainUI();
            } else {
                if(container) container.classList.add('hidden');
                if(modal) modal.classList.remove('hidden');
                renderLoginButtons();
            }
        }

        function renderLoginButtons() {
            const grid = document.getElementById('login-grid');
            grid.innerHTML = "";
            USER_SLOTS.forEach((slot, idx) => {
                const btn = document.createElement('div');
                const user = appData.auth[slot];
                if(user) {
                    btn.className = "login-btn taken";
                    btn.innerHTML = `üîí ${user.name}`;
                    btn.onclick = () => tryLogin(slot, user.pin);
                } else {
                    btn.className = "login-btn";
                    btn.innerHTML = `+ New`;
                    btn.onclick = () => tryRegister(slot);
                }
                grid.appendChild(btn);
            });
        }

        window.tryLogin = function(slot, correctPin) {
            const input = prompt("PIN Î≤àÌò∏:");
            if(input === correctPin) {
                myName = slot;
                localStorage.setItem('myId', slot);
                checkLoginStatus();
            } else { alert("ÎπÑÎ∞ÄÎ≤àÌò∏ Î∂àÏùºÏπò"); }
        };

        window.tryRegister = function(slot) {
            const name = prompt("Ïù¥Î¶Ñ:");
            if(!name) return;
            const pin = prompt("ÎπÑÎ∞ÄÎ≤àÌò∏:");
            if(!pin) return;
            appData.auth[slot] = { name: name, pin: pin };
            if(!appData[slot]) appData[slot] = { resolution: [], bible: {}, history: {} };
            saveData().then(() => {
                myName = slot;
                localStorage.setItem('myId', slot);
                checkLoginStatus();
            });
        };

        window.logoutAction = function() {
            if(confirm("Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                localStorage.removeItem('myId');
                myName = null;
                checkLoginStatus();
            }
        };

        function updateMainUI() {
            document.getElementById('user-name').innerText = appData.auth[myName].name;
            renderResolutionList();
            renderMessages();
            renderAdvancedStats();
            updateBibleStats();
        }

        function renderResolutionList() {
            const list = document.getElementById('list-resolution');
            list.innerHTML = "";
            const myItems = appData[myName].resolution || [];
            
            myItems.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = "resolution-item";
                
                let stepsHtml = "";
                item.steps.forEach((stepName, sIdx) => {
                    const isDone = item.done[sIdx] ? "done" : "";
                    stepsHtml += `<span class="step-item ${isDone}" onclick="window.toggleStep(${idx}, ${sIdx})">${stepName}</span>`;
                });

                li.innerHTML = `
                    <div class="res-left">
                        <div class="res-text" onclick="window.editItem(${idx})">${item.text}</div>
                        <div class="steps">${stepsHtml}</div>
                    </div>
                    <button class="del-icon-btn" onclick="window.deleteItem(${idx})"><i class="fas fa-trash-alt"></i></button>
                `;
                list.appendChild(li);
            });
        }

        // [ÌïµÏã¨ Î°úÏßÅ] ÌÜµÍ≥Ñ Î∞è Îû≠ÌÇπ Í≥ÑÏÇ∞
        function renderAdvancedStats() {
            const period = appData.period || { start: "2024-01-01", end: "2024-12-31" };
            document.getElementById('period-display').innerText = `${period.start} ~ ${period.end}`;

            const myHistory = appData[myName].history || {};
            const myBible = appData[myName].bible || {};
            const today = new Date().toISOString().split('T')[0];
            
            // 1. Heatmap & Ìï≠Î™©Î≥Ñ Í∑∏ÎûòÌîÑ
            const heatGrid = document.getElementById('heatmap-grid');
            heatGrid.innerHTML = "";
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            let maxDone = 0;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if(myHistory[dateStr] && myHistory[dateStr] > maxDone) maxDone = myHistory[dateStr];
            }
            if(maxDone === 0) maxDone = 1;

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const val = myHistory[dateStr] || 0;
                const cell = document.createElement('div');
                cell.className = "heat-day";
                if(val > 0) {
                    const ratio = val / maxDone;
                    if(ratio < 0.4) cell.classList.add("level-1");
                    else if(ratio < 0.7) cell.classList.add("level-2");
                    else cell.classList.add("level-3");
                }
                if(dateStr === today) cell.classList.add("today");
                cell.innerText = d;
                heatGrid.appendChild(cell);
            }

            const goalList = document.getElementById('goal-breakdown-list');
            goalList.innerHTML = "";
            const myGoals = appData[myName].resolution || [];
            if(myGoals.length === 0) {
                goalList.innerHTML = "<p style='text-align:center; color:#94a3b8; font-size:0.9rem;'>Îì±Î°ùÎêú Î™©ÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>";
            } else {
                myGoals.forEach(g => {
                    const totalDone = (g.counts || []).reduce((a,b)=>a+b, 0);
                    const div = document.createElement('div');
                    div.className = "goal-stat-item";
                    div.innerHTML = `
                        <div class="goal-label-row">
                            <span class="goal-name">${g.text}</span>
                            <span class="goal-percent">Ï¥ù ${totalDone}Ìöå</span>
                        </div>
                        <div class="progress-bg"><div class="progress-bar" style="width: 100%; opacity: 0.2"></div></div>
                    `;
                    goalList.appendChild(div);
                });
            }

            // 2. Îû≠ÌÇπ Î†åÎçîÎßÅ (Ïó¨Í∏∞Í∞Ä Î≥ÄÍ≤ΩÎê®)
            renderRankings(period);
        }

        // [Ï§ëÏöî] Ï£ºÍ∞Ñ ÎÇ†Ïßú Î≤îÏúÑ Íµ¨ÌïòÍ∏∞ (ÌÜ†ÏöîÏùº ~ Í∏àÏöîÏùº)
        function getWeeklyRange() {
            const now = new Date();
            const day = now.getDay(); // 0(Ïùº)~6(ÌÜ†)
            
            // Í∏∞Ï§ÄÏ†ê: Í∞ÄÏû• ÏµúÍ∑º ÌÜ†ÏöîÏùº (Ïò§ÎäòÏù¥ ÌÜ†ÏöîÏùºÏù¥Î©¥ Ïò§Îäò)
            const diff = day === 6 ? 0 : day + 1; 
            
            const start = new Date(now);
            start.setDate(now.getDate() - diff);
            const startStr = start.toISOString().split('T')[0];
            
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            const endStr = end.toISOString().split('T')[0];
            
            return { start: startStr, end: endStr };
        }

        function renderRankings(period) {
            const activeUsers = USER_SLOTS.filter(u => appData.auth && appData.auth[u]);
            
            // (1) Í≤∞Îã®ÏÑú Îû≠ÌÇπ: ÏãúÏ¶å Í∏∞Í∞Ñ(appData.period) Í∏∞Ï§Ä
            const resRankEl = document.getElementById('rank-resolution');
            resRankEl.innerHTML = "";
            activeUsers.map(u => {
                const h = appData[u].history || {};
                let score = 0;
                Object.keys(h).forEach(date => { if(date >= period.start && date <= period.end) score += h[date]; });
                return { name: appData.auth[u].name, val: score };
            }).sort((a,b) => b.val - a.val).forEach((r, i) => {
                resRankEl.innerHTML += `<div class="rank-row"><span>${i+1}. ${r.name}</span><span class="score">${r.val}Ï†ê</span></div>`;
            });

            // (2) ÏÑ±Í≤Ω Îû≠ÌÇπ: Ïù¥Î≤à Ï£º(ÌÜ†~Í∏à) Í∏∞Ï§Ä
            const weekRange = getWeeklyRange();
            document.querySelector('.ranking-title:nth-child(1)').nextElementSibling.parentElement.nextElementSibling.querySelector('.ranking-title').innerText = `üìñ ÏÑ±Í≤Ω (${weekRange.start.slice(5)}~)`;

            const bibRankEl = document.getElementById('rank-bible');
            bibRankEl.innerHTML = "";
            activeUsers.map(u => {
                const b = appData[u].bible || {};
                let count = 0;
                Object.values(b).forEach(date => { 
                    if(date >= weekRange.start && date <= weekRange.end) count++; 
                });
                return { name: appData.auth[u].name, val: count };
            }).sort((a,b) => b.val - a.val).forEach((r, i) => {
                bibRankEl.innerHTML += `<div class="rank-row"><span>${i+1}. ${r.name}</span><span class="score">${r.val}Ïû•</span></div>`;
            });
        }

        function updateBibleStats() {
            const today = new Date().toISOString().split('T')[0];
            const yearStr = new Date().getFullYear().toString();
            const myBible = appData[myName].bible || {};
            
            let todayCnt = 0;
            let yearCnt = 0;
            Object.values(myBible).forEach(date => {
                if(date === today) todayCnt++;
                if(date.startsWith(yearStr)) yearCnt++;
            });

            document.getElementById('bible-today-count').innerText = `+${todayCnt}Ïû•`;
            document.getElementById('bible-year-count').innerText = `${yearCnt}Ïû•`;
        }

        window.setPeriod = function() {
            const current = appData.period || {start:"", end:""};
            const s = prompt("ÏãúÏûëÏùº (YYYY-MM-DD)", current.start);
            if(!s) return;
            const e = prompt("Ï¢ÖÎ£åÏùº (YYYY-MM-DD)", current.end);
            if(!e) return;
            appData.period = { start: s, end: e };
            saveData().then(() => alert("Í∏∞Í∞Ñ ÏÑ§Ï†ï ÏôÑÎ£å!"));
        };

        window.addItem = function() {
            const input = document.getElementById('input-resolution');
            const val = input.value.trim();
            if(!val) return;
            const parts = val.split('/');
            const title = parts[0].trim();
            const steps = parts.length > 1 ? parts.slice(1).map(s=>s.trim()) : ["ÏôÑÎ£å"];
            
            if(!appData[myName].resolution) appData[myName].resolution = [];
            appData[myName].resolution.push({ 
                text: title, steps: steps, done: Array(steps.length).fill(false), counts: Array(steps.length).fill(0) 
            });
            input.value = "";
            saveData();
        };

        window.toggleStep = function(itemIdx, stepIdx) {
            const item = appData[myName].resolution[itemIdx];
            const wasDone = item.done[stepIdx];
            item.done[stepIdx] = !wasDone;
            
            if(!item.counts) item.counts = Array(item.steps.length).fill(0);
            if(item.done[stepIdx]) item.counts[stepIdx]++;
            else item.counts[stepIdx] = Math.max(0, item.counts[stepIdx] - 1);

            if(item.done[stepIdx] && window.confetti) confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            
            const today = new Date().toISOString().split('T')[0];
            if(!appData[myName].history) appData[myName].history = {};
            let totalDone = 0;
            appData[myName].resolution.forEach(r => r.done.forEach(d => { if(d) totalDone++; }));
            appData[myName].history[today] = totalDone;
            
            saveData();
        };

        window.deleteItem = function(idx) {
            if(confirm("Ïù¥ Î™©ÌëúÎ•º ÏÇ≠Ï†úÌï†ÍπåÏöî?")) {
                appData[myName].resolution.splice(idx, 1);
                saveData();
            }
        };

        window.editItem = function(idx) {
            const item = appData[myName].resolution[idx];
            const newText = prompt("Î™©Ìëú ÏàòÏ†ï:", item.text);
            if(newText) { item.text = newText; saveData(); }
        };

        window.sendMsg = function() {
            const input = document.getElementById('input-msg');
            const txt = input.value.trim();
            if(!txt) return;
            if(!appData.messages) appData.messages = [];
            appData.messages.push({ sender: appData.auth[myName].name, text: txt });
            if(appData.messages.length > 50) appData.messages.shift();
            input.value = "";
            saveData();
        };

        function renderMessages() {
            const list = document.getElementById('msg-list');
            list.innerHTML = "";
            [...(appData.messages||[])].reverse().forEach(m => {
                const li = document.createElement('li');
                li.innerHTML = `<b>${m.sender}:</b> ${m.text}`;
                list.appendChild(li);
            });
        }

        window.showBibleBooks = function(type) {
            bibleState.currentTestament = type;
            document.getElementById('bible-main-view').classList.add('hidden-view');
            document.getElementById('bible-books-view').classList.remove('hidden-view');
            
            const grid = document.getElementById('bible-books-grid');
            grid.innerHTML = "";
            document.getElementById('bible-testament-title').innerText = type==='old'?"Íµ¨ÏïΩ":"Ïã†ÏïΩ";
            
            BIBLE_DATA.books.filter(b=>b.testament===type).forEach(book => {
                const div = document.createElement('div');
                div.className = "bible-btn";
                const yearStr = new Date().getFullYear().toString();
                let readCount = 0;
                for(let i=1; i<=book.chapters; i++) {
                    const date = appData[myName].bible && appData[myName].bible[`${book.name}-${i}`];
                    if(date && date.startsWith(yearStr)) readCount++;
                }
                if(readCount >= book.chapters) div.classList.add('completed');
                div.innerText = book.name;
                div.onclick = () => showChapters(book);
                grid.appendChild(div);
            });
        };

        function showChapters(book) {
            bibleState.currentBook = book.name;
            document.getElementById('bible-books-view').classList.add('hidden-view');
            document.getElementById('bible-chapters-view').classList.remove('hidden-view');
            document.getElementById('bible-book-title').innerText = book.name;
            renderChaptersGrid();
        }

        function renderChaptersGrid() {
            const book = BIBLE_DATA.books.find(b => b.name === bibleState.currentBook);
            const grid = document.getElementById('bible-chapters-grid');
            grid.innerHTML = "";
            const yearStr = new Date().getFullYear().toString();
            
            let allChecked = true;
            for(let i=1; i<=book.chapters; i++) {
                const div = document.createElement('div');
                div.className = "chapter-item";
                const key = `${book.name}-${i}`;
                const date = appData[myName].bible && appData[myName].bible[key];
                const isRead = date && date.startsWith(yearStr);
                if(isRead) div.classList.add('checked');
                else allChecked = false;
                
                div.innerText = i;
                div.onclick = () => { window.toggleChapter(key, !isRead); };
                grid.appendChild(div);
            }
            
            const finishBtn = document.getElementById('btn-finish-book');
            if(allChecked) {
                finishBtn.classList.remove('disabled');
                finishBtn.innerText = "Ïù¥ Ï±Ö ÏôÑÎèÖÌïòÍ∏∞ üéâ";
            } else {
                finishBtn.classList.add('disabled');
                finishBtn.innerText = "Î™®Îëê ÏùΩÏñ¥Ïïº ÏôÑÎèÖ Í∞ÄÎä•";
            }
        }

        window.controlAll = function(turnOn) {
            const book = BIBLE_DATA.books.find(b => b.name === bibleState.currentBook);
            if(!appData[myName].bible) appData[myName].bible = {};
            const today = new Date().toISOString().split('T')[0];
            
            for(let i=1; i<=book.chapters; i++) {
                const key = `${book.name}-${i}`;
                if(turnOn) appData[myName].bible[key] = today;
                else delete appData[myName].bible[key];
            }
            saveData().then(() => renderChaptersGrid());
        };

        window.finishBookAndReset = function() {
            const btn = document.getElementById('btn-finish-book');
            if(btn.classList.contains('disabled')) return; 

            if(confirm(`'${bibleState.currentBook}'ÏùÑ(Î•º) ÏôÑÎèÖ Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏ≤¥ÌÅ¨Î∞ïÏä§Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÍ≥† 'nÎèÖ' Ïπ¥Ïö¥Ìä∏Í∞Ä Ïò¨ÎùºÍ∞ëÎãàÎã§.`)) {
                if(!appData[myName].bibleRounds) appData[myName].bibleRounds = {};
                const book = bibleState.currentBook;
                appData[myName].bibleRounds[book] = (appData[myName].bibleRounds[book] || 0) + 1;
                window.controlAll(false);
            }
        };

        window.toggleChapter = function(key, checked) {
            if(!appData[myName].bible) appData[myName].bible = {};
            if(checked) appData[myName].bible[key] = new Date().toISOString().split('T')[0];
            else delete appData[myName].bible[key];
            saveData().then(() => renderChaptersGrid());
        };

        window.showBibleMain = function() {
            document.getElementById('bible-books-view').classList.add('hidden-view');
            document.getElementById('bible-main-view').classList.remove('hidden-view');
        };
        window.backToBooks = function() {
            document.getElementById('bible-chapters-view').classList.add('hidden-view');
            document.getElementById('bible-books-view').classList.remove('hidden-view');
        };

        window.goTab = function(tab, btn) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.page').forEach(e => e.classList.add('hidden'));
            document.getElementById('page-'+tab).classList.remove('hidden');
            
            if(tab==='stats') renderAdvancedStats();
            if(tab==='bible') updateBibleStats();
        };

        window.saveAlarmTime = function() { alert("ÏïåÎûå Í∏∞Îä• Ï§ÄÎπÑÏ§ë üîî"); };

        async function saveData() {
            try { await setDoc(docRef, { appData: appData }, { merge: true }); updateMainUI(); }
            catch(e) { console.error(e); }
        }

        function initNewData() {
            const y = new Date().getFullYear();
            appData = { auth: {}, messages: [], period: { start: `${y}-01-01`, end: `${y}-12-31` } };
            saveData();
        }

        startApp();
    </script>
</body>
</html>
