<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Goals V2.7</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5; --primary-soft: #e0e7ff; --bg-color: #f8fafc;
            --text-main: #1e293b; --text-light: #64748b; --accent: #f43f5e;
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1); --radius-pill: 50px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; background: var(--bg-color); color: var(--text-main); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; } .hidden-view { display: none !important; }

        /* ê³µí†µ UI */
        #splash-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .logo-circle { font-size: 4rem; margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .modal-content { background: white; width: 85%; max-width: 360px; padding: 25px; border-radius: 24px; box-shadow: var(--shadow-md); max-height: 80vh; overflow-y: auto; }
        
        /* ë¡œê·¸ì¸ */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .login-btn { padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; background: white; font-weight: 500; cursor: pointer; }
        .login-btn.taken { background: var(--primary-soft); color: var(--primary); font-weight: 700; border: none; }

        /* ìˆ˜ì • ëª¨ë‹¬ (New!) */
        .edit-label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 5px; display: block; font-weight: 600; }
        .edit-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; font-size: 1rem; }
        .step-edit-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .step-edit-input { flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; }
        .btn-remove-step { color: var(--accent); background: #fee2e2; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-add-step { width: 100%; padding: 10px; background: #f1f5f9; border: 1px dashed #cbd5e1; border-radius: 12px; color: var(--text-light); cursor: pointer; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; }
        .btn-cancel { flex: 1; padding: 12px; background: #f1f5f9; border: none; border-radius: 12px; cursor: pointer; }
        .btn-save { flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* ì•± ë ˆì´ì•„ì›ƒ */
        #app-container { display: flex; flex-direction: column; height: 100%; }
        .glass-header { padding: 15px 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 10; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .round-btn { width: 36px; height: 36px; border-radius: 50%; background: white; border: 1px solid #e2e8f0; margin-left: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        #main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 200px; }

        /* ì¹´ë“œ & ë¦¬ìŠ¤íŠ¸ */
        .verse-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 10px 15px -3px rgba(118, 75, 162, 0.3); }
        .input-pill { background: white; border-radius: var(--radius-pill); padding: 5px 5px 5px 20px; display: flex; align-items: center; box-shadow: var(--shadow-sm); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .input-pill input { flex: 1; border: none; font-size: 0.95rem; background: transparent; }
        .add-circle-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 1.4rem; cursor: pointer; }
        
        .resolution-item { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .res-left { flex: 1; }
        .res-text { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 8px; }
        .steps { display: flex; gap: 6px; flex-wrap: wrap; }
        .step-item { background: #f1f5f9; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; color: var(--text-light); cursor: pointer; }
        .step-item.done { background: var(--primary); color: white; }
        .edit-icon-btn { background: none; border: none; color: #cbd5e1; font-size: 1rem; padding: 10px; cursor: pointer; } /* ìˆ˜ì • ì•„ì´ì½˜ */

        /* ì„±ê²½ & í†µê³„ */
        .bible-card { display: flex; align-items: center; padding: 20px; border-radius: 20px; margin-bottom: 12px; cursor: pointer; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .grid-chapters { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .chapter-item { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 0; text-align: center; cursor: pointer; font-size: 0.9rem; }
        .chapter-item.checked { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        
        .stat-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .heatmap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .heat-day { aspect-ratio: 1; border-radius: 6px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #cbd5e1; }
        .heat-day.active { background: var(--primary); color: white; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: rgba(255,255,255,0.95); display: flex; justify-content: space-around; padding-bottom: 20px; border-top: 1px solid rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { background: none; border: none; color: #94a3b8; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="logo-circle">â›ªï¸</div>
        <h1>FAMILY GOALS</h1>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="text-align:center;">Welcome</h2>
            <div id="login-grid" class="grid-container"></div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-top:0;">ëª©í‘œ ìˆ˜ì •í•˜ê¸° âœï¸</h3>
            
            <label class="edit-label">ëª©í‘œ ì´ë¦„</label>
            <input type="text" id="edit-title" class="edit-input">
            
            <label class="edit-label">ì„¸ë¶€ ë‹¨ê³„ (Steps)</label>
            <div id="edit-steps-container"></div>
            <button class="btn-add-step" onclick="window.addStepInput()">+ ë‹¨ê³„ ì¶”ê°€</button>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="window.closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn-save" onclick="window.saveEditModal()">ì €ì¥</button>
            </div>
            <button onclick="window.deleteItemFromModal()" style="width:100%; margin-top:10px; background:none; border:none; color:#ef4444; cursor:pointer;">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header class="glass-header">
            <div class="header-content">
                <span style="font-weight:bold; font-size:1.2rem;">Hi, <b id="user-name">User</b></span>
                <div class="header-actions">
                    <button class="round-btn" onclick="window.saveAlarmTime()">ğŸ””</button>
                    <button class="round-btn" onclick="window.logoutAction()">ğŸšª</button>
                </div>
            </div>
        </header>

        <main id="main-content">
            <div class="verse-card">
                <div style="font-size:0.8rem; opacity:0.8; margin-bottom:5px;">Today's Verse</div>
                <p id="verse-text" style="margin:0; font-weight:500;">Loading...</p>
                <p id="verse-ref" style="text-align:right; font-size:0.8rem; margin-top:5px;"></p>
            </div>

            <div id="page-resolution" class="page active">
                <h3 style="margin-bottom:10px;">My Goals</h3>
                <div class="input-pill">
                    <input type="text" id="input-resolution" placeholder="ìƒˆ ëª©í‘œ (ì˜ˆ: ë§¤ì¼ ìš´ë™)">
                    <button onclick="window.addItem()" class="add-circle-btn">+</button>
                </div>
                <ul id="list-resolution" style="list-style:none; padding:0;"></ul>
                
                <h3 style="margin-top:40px; margin-bottom:10px;">Family Chat</h3>
                <div class="chat-container">
                    <ul id="msg-list" style="list-style:none; padding:0; margin:0;"></ul>
                    <div class="input-pill small" style="margin-top:10px; padding-left:15px;">
                        <input type="text" id="input-msg" placeholder="ë©”ì‹œì§€...">
                        <button onclick="window.sendMsg()" style="background:#333; color:white; border:none; padding:5px 15px; border-radius:20px;">ì „ì†¡</button>
                    </div>
                </div>
            </div>

            <div id="page-bible" class="page hidden">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <div class="stat-card" style="flex:1; text-align:center; padding:15px;">
                        <span style="font-size:0.8rem; color:#888;">ì˜¤ëŠ˜ ì½ìŒ</span><br>
                        <strong style="font-size:1.3rem; color:var(--primary);" id="bible-today-count">0</strong>
                    </div>
                    <div class="stat-card" style="flex:1; text-align:center; padding:15px;">
                        <span style="font-size:0.8rem; color:#888;">ì˜¬í•´ ëˆ„ì </span><br>
                        <strong style="font-size:1.3rem;" id="bible-year-count">0</strong>
                    </div>
                </div>

                <div id="bible-main-view">
                    <div class="bible-card old" onclick="window.showBibleBooks('old')">
                        <div class="card-icon" style="font-size:2rem; margin-right:15px;">ğŸ“œ</div>
                        <div><h3>êµ¬ì•½ (Old)</h3><p style="margin:0; color:#888;">39ê¶Œ</p></div>
                    </div>
                    <div class="bible-card new" onclick="window.showBibleBooks('new')">
                        <div class="card-icon" style="font-size:2rem; margin-right:15px;">âœï¸</div>
                        <div><h3>ì‹ ì•½ (New)</h3><p style="margin:0; color:#888;">27ê¶Œ</p></div>
                    </div>
                </div>

                <div id="bible-books-view" class="hidden-view">
                    <button onclick="window.showBibleMain()" style="background:none; border:none; margin-bottom:10px;">â† ë’¤ë¡œ</button>
                    <h3 id="bible-testament-title"></h3>
                    <div id="bible-books-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;"></div>
                </div>

                <div id="bible-chapters-view" class="hidden-view">
                    <button onclick="window.backToBooks()" style="background:none; border:none; margin-bottom:10px;">â† ëª©ë¡</button>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 id="bible-book-title" style="margin:0;"></h3>
                        <div>
                            <button onclick="window.controlAll(true)" style="background:#eee; border:none; padding:5px 10px; border-radius:10px;">ì „ì²´</button>
                            <button onclick="window.controlAll(false)" style="background:#eee; border:none; padding:5px 10px; border-radius:10px;">í•´ì œ</button>
                        </div>
                    </div>
                    <button id="btn-finish-book" onclick="window.finishBookAndReset()" style="width:100%; padding:12px; background:#333; color:white; border:none; border-radius:12px; margin-bottom:20px;">ì´ ì±… ì™„ë…í•˜ê¸° ğŸ‰</button>
                    <div id="bible-chapters-grid" class="grid-chapters"></div>
                </div>
            </div>

            <div id="page-stats" class="page hidden">
                <div class="period-card" onclick="window.manageSeason()" style="background:linear-gradient(135deg, #4f46e5, #ec4899); color:white; padding:20px; border-radius:20px; text-align:center; margin-bottom:20px;">
                    <div style="font-size:0.8rem; opacity:0.8;">ğŸ† í˜„ì¬ ì‹œì¦Œ (í´ë¦­í•˜ì—¬ ë§ˆê°)</div>
                    <div id="period-display" style="font-size:1.1rem; font-weight:bold;">ì„¤ì • í•„ìš”</div>
                </div>

                <h3>ê°€ì¡± ë­í‚¹</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <div class="stat-card" style="flex:1;">
                        <div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px; font-weight:bold;">ğŸ“ ê²°ë‹¨ì„œ</div>
                        <div id="rank-resolution"></div>
                    </div>
                    <div class="stat-card" style="flex:1;">
                        <div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px; font-weight:bold;">ğŸ“– ì„±ê²½</div>
                        <div id="rank-bible"></div>
                    </div>
                </div>

                <h3>ë‚˜ì˜ í˜„í™©</h3>
                <div class="stat-card" style="display:flex; justify-content:space-around; margin-bottom:20px;">
                    <div style="text-align:center;"><strong style="font-size:1.4rem; color:var(--primary);" id="stat-rate">0%</strong><br><span style="font-size:0.8rem; color:#888;">ì„±ê³µë¥ </span></div>
                    <div style="width:1px; background:#eee;"></div>
                    <div style="text-align:center;"><strong style="font-size:1.4rem; color:var(--primary);" id="stat-bible-total">0</strong><br><span style="font-size:0.8rem; color:#888;">ì˜¬í•´ ì½ìŒ</span></div>
                </div>

                <div onclick="window.toggleAccordion('acc-goals')" style="display:flex; justify-content:space-between; padding:10px 0; font-weight:bold; cursor:pointer;">
                    ëª©í‘œë³„ ë‹¬ì„±ë„ <span>â–¼</span>
                </div>
                <div id="acc-goals" class="hidden"><div class="stat-card" id="goal-breakdown-list"></div></div>

                <div onclick="window.toggleAccordion('acc-heatmap')" style="display:flex; justify-content:space-between; padding:10px 0; font-weight:bold; cursor:pointer;">
                    ì´ë²ˆ ë‹¬ í™œë™ <span>â–¼</span>
                </div>
                <div id="acc-heatmap" class="hidden"><div class="stat-card"><div id="heatmap-grid" class="heatmap"></div></div></div>

                <h3 style="margin-top:30px;">ğŸ‘‘ ëª…ì˜ˆì˜ ì „ë‹¹</h3>
                <div class="stat-card" id="hall-of-fame-list"></div>
            </div>
        </main>

        <nav class="bottom-nav" style="position:fixed; bottom:0; width:100%; height:80px; background:rgba(255,255,255,0.95); display:flex; justify-content:space-around; padding-bottom:20px; border-top:1px solid #eee; z-index:100;">
            <button class="nav-item active" onclick="window.goTab('resolution', this)" style="background:none; border:none; width:100%;">
                <i class="fas fa-list-check" style="font-size:1.4rem; margin-bottom:4px;"></i><br><span style="font-size:0.7rem;">ëª©í‘œ</span>
            </button>
            <button class="nav-item" onclick="window.goTab('bible', this)" style="background:none; border:none; width:100%;">
                <i class="fas fa-book-open" style="font-size:1.4rem; margin-bottom:4px;"></i><br><span style="font-size:0.7rem;">ì„±ê²½</span>
            </button>
            <button class="nav-item" onclick="window.goTab('stats', this)" style="background:none; border:none; width:100%;">
                <i class="fas fa-chart-simple" style="font-size:1.4rem; margin-bottom:4px;"></i><br><span style="font-size:0.7rem;">ìˆœìœ„</span>
            </button>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â–¼â–¼â–¼ Config ì…ë ¥ë€ â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyD0Vorv3SFatQuC7OCYHPA-Nok4DlqonrI",
            authDomain: "family-resolution.firebaseapp.com",
            projectId: "family-resolution",
            storageBucket: "family-resolution.firebasestorage.app",
            messagingSenderId: "711396068080",
            appId: "1:711396068080:web:861c41a8259f0b6dca9035",
            measurementId: "G-RH6E87B4H0"
        };

        const BIBLE_DATA = { "books": [ { "name": "ì°½ì„¸ê¸°", "chapters": 50, "testament": "old" }, { "name": "ì¶œì• êµ½ê¸°", "chapters": 40, "testament": "old" }, { "name": "ë ˆìœ„ê¸°", "chapters": 27, "testament": "old" }, { "name": "ë¯¼ìˆ˜ê¸°", "chapters": 36, "testament": "old" }, { "name": "ì‹ ëª…ê¸°", "chapters": 34, "testament": "old" }, { "name": "ì—¬í˜¸ìˆ˜ì•„", "chapters": 24, "testament": "old" }, { "name": "ì‚¬ì‚¬ê¸°", "chapters": 21, "testament": "old" }, { "name": "ë£»ê¸°", "chapters": 4, "testament": "old" }, { "name": "ì‚¬ë¬´ì—˜ìƒ", "chapters": 31, "testament": "old" }, { "name": "ì‚¬ë¬´ì—˜í•˜", "chapters": 24, "testament": "old" }, { "name": "ì—´ì™•ê¸°ìƒ", "chapters": 22, "testament": "old" }, { "name": "ì—´ì™•ê¸°í•˜", "chapters": 25, "testament": "old" }, { "name": "ì—­ëŒ€ìƒ", "chapters": 29, "testament": "old" }, { "name": "ì—­ëŒ€í•˜", "chapters": 36, "testament": "old" }, { "name": "ì—ìŠ¤ë¼", "chapters": 10, "testament": "old" }, { "name": "ëŠí—¤ë¯¸ì•¼", "chapters": 13, "testament": "old" }, { "name": "ì—ìŠ¤ë”", "chapters": 10, "testament": "old" }, { "name": "ìš¥ê¸°", "chapters": 42, "testament": "old" }, { "name": "ì‹œí¸", "chapters": 150, "testament": "old" }, { "name": "ì ì–¸", "chapters": 31, "testament": "old" }, { "name": "ì „ë„ì„œ", "chapters": 12, "testament": "old" }, { "name": "ì•„ê°€", "chapters": 8, "testament": "old" }, { "name": "ì´ì‚¬ì•¼", "chapters": 66, "testament": "old" }, { "name": "ì˜ˆë ˆë¯¸ì•¼", "chapters": 52, "testament": "old" }, { "name": "ì˜ˆë ˆë¯¸ì•¼ì• ê°€", "chapters": 5, "testament": "old" }, { "name": "ì—ìŠ¤ê²”", "chapters": 48, "testament": "old" }, { "name": "ë‹¤ë‹ˆì—˜", "chapters": 12, "testament": "old" }, { "name": "í˜¸ì„¸ì•„", "chapters": 14, "testament": "old" }, { "name": "ìš”ì—˜", "chapters": 3, "testament": "old" }, { "name": "ì•„ëª¨ìŠ¤", "chapters": 9, "testament": "old" }, { "name": "ì˜¤ë°”ëŒœ", "chapters": 1, "testament": "old" }, { "name": "ìš”ë‚˜", "chapters": 4, "testament": "old" }, { "name": "ë¯¸ê°€", "chapters": 7, "testament": "old" }, { "name": "ë‚˜í›”", "chapters": 3, "testament": "old" }, { "name": "í•˜ë°•êµ­", "chapters": 3, "testament": "old" }, { "name": "ìŠ¤ë°”ëƒ", "chapters": 3, "testament": "old" }, { "name": "í•™ê°œ", "chapters": 2, "testament": "old" }, { "name": "ìŠ¤ê°€ë´", "chapters": 14, "testament": "old" }, { "name": "ë§ë¼ê¸°", "chapters": 4, "testament": "old" }, { "name": "ë§ˆíƒœë³µìŒ", "chapters": 28, "testament": "new" }, { "name": "ë§ˆê°€ë³µìŒ", "chapters": 16, "testament": "new" }, { "name": "ëˆ„ê°€ë³µìŒ", "chapters": 24, "testament": "new" }, { "name": "ìš”í•œë³µìŒ", "chapters": 21, "testament": "new" }, { "name": "ì‚¬ë„í–‰ì „", "chapters": 28, "testament": "new" }, { "name": "ë¡œë§ˆì„œ", "chapters": 16, "testament": "new" }, { "name": "ê³ ë¦°ë„ì „ì„œ", "chapters": 16, "testament": "new" }, { "name": "ê³ ë¦°ë„í›„ì„œ", "chapters": 13, "testament": "new" }, { "name": "ê°ˆë¼ë””ì•„ì„œ", "chapters": 6, "testament": "new" }, { "name": "ì—ë² ì†Œì„œ", "chapters": 6, "testament": "new" }, { "name": "ë¹Œë¦½ë³´ì„œ", "chapters": 4, "testament": "new" }, { "name": "ê³¨ë¡œìƒˆì„œ", "chapters": 4, "testament": "new" }, { "name": "ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ", "chapters": 5, "testament": "new" }, { "name": "ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ", "chapters": 3, "testament": "new" }, { "name": "ë””ëª¨ë°ì „ì„œ", "chapters": 6, "testament": "new" }, { "name": "ë””ëª¨ë°í›„ì„œ", "chapters": 4, "testament": "new" }, { "name": "ë””ë„ì„œ", "chapters": 3, "testament": "new" }, { "name": "ë¹Œë ˆëª¬ì„œ", "chapters": 1, "testament": "new" }, { "name": "íˆë¸Œë¦¬ì„œ", "chapters": 13, "testament": "new" }, { "name": "ì•¼ê³ ë³´ì„œ", "chapters": 5, "testament": "new" }, { "name": "ë² ë“œë¡œì „ì„œ", "chapters": 5, "testament": "new" }, { "name": "ë² ë“œë¡œí›„ì„œ", "chapters": 3, "testament": "new" }, { "name": "ìš”í•œ1ì„œ", "chapters": 5, "testament": "new" }, { "name": "ìš”í•œ2ì„œ", "chapters": 1, "testament": "new" }, { "name": "ìš”í•œ3ì„œ", "chapters": 1, "testament": "new" }, { "name": "ìœ ë‹¤ì„œ", "chapters": 1, "testament": "new" }, { "name": "ìš”í•œê³„ì‹œë¡", "chapters": 22, "testament": "new" } ] };
        const USER_SLOTS = ["user_1", "user_2", "user_3", "user_4", "user_5", "user_6"];

        let app, db, docRef;
        let appData = {};
        let bibleState = { currentTestament: null, currentBook: null };
        let myName = localStorage.getItem('myId');
        let editIdx = null; // ìˆ˜ì • ì¤‘ì¸ ì•„ì´í…œ ì¸ë±ìŠ¤

        async function startApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                docRef = doc(db, "appData", "familyDataV28_Secure");

                onSnapshot(docRef, (snapshot) => {
                    document.getElementById('splash-screen').style.opacity = '0';
                    setTimeout(()=> document.getElementById('splash-screen').style.display='none', 500);

                    if(snapshot.exists()) {
                        const data = snapshot.data();
                        appData = data.appData ? data.appData : data;
                        if(!appData.auth) appData.auth = {};
                        if(!appData.period) {
                            const y = new Date().getFullYear();
                            appData.period = { start: `${y}-01-01`, end: `${y}-12-31` };
                        }
                        if(!appData.pastSeasons) appData.pastSeasons = [];
                        
                        USER_SLOTS.forEach(slot => {
                            if(!appData[slot]) appData[slot] = { resolution: [], bible: {}, history: {}, bibleRounds: {} };
                        });
                        checkLoginStatus();
                    } else {
                        initNewData();
                    }
                });

                const verses = [ {t:"ë‚´ê²Œ ëŠ¥ë ¥ ì£¼ì‹œëŠ” ì ì•ˆì—ì„œ ë‚´ê°€ ëª¨ë“  ê²ƒì„ í•  ìˆ˜ ìˆëŠë‹ˆë¼",r:"ë¹Œ4:13"}, {t:"ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤",r:"ì‹œ23:1"}, {t:"ë‘ë ¤ì›Œí•˜ì§€ ë§ë¼ ë‚´ê°€ ë„ˆì™€ í•¨ê»˜ í•¨ì´ë¼",r:"ì‚¬41:10"} ];
                const v = verses[Math.floor(Math.random()*verses.length)];
                document.getElementById('verse-text').innerText = v.t;
                document.getElementById('verse-ref').innerText = v.r;
            } catch (e) { alert("Config ì˜¤ë¥˜"); }
        }

        function checkLoginStatus() {
            if(myName && appData.auth[myName]) {
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                updateMainUI();
            } else {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('login-modal').classList.remove('hidden');
                renderLoginButtons();
            }
        }

        function renderLoginButtons() {
            const grid = document.getElementById('login-grid');
            grid.innerHTML = "";
            USER_SLOTS.forEach((slot, idx) => {
                const btn = document.createElement('div');
                const user = appData.auth[slot];
                if(user) {
                    btn.className = "login-btn taken"; btn.innerHTML = `ğŸ”’ ${user.name}`;
                    btn.onclick = () => tryLogin(slot, user.pin);
                } else {
                    btn.className = "login-btn"; btn.innerHTML = `+ New`;
                    btn.onclick = () => tryRegister(slot);
                }
                grid.appendChild(btn);
            });
        }

        window.tryLogin = (s, p) => { if(prompt("PIN:")===p) { myName=s; localStorage.setItem('myId',s); checkLoginStatus(); } else alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); };
        window.tryRegister = (s) => { const n=prompt("ì´ë¦„:"); if(!n)return; const p=prompt("PIN:"); if(!p)return; appData.auth[s]={name:n,pin:p}; if(!appData[s])appData[s]={resolution:[],bible:{},history:{}}; saveData().then(()=>{myName=s; localStorage.setItem('myId',s); checkLoginStatus();}); };
        window.logoutAction = () => { if(confirm("ë¡œê·¸ì•„ì›ƒ?")) { localStorage.removeItem('myId'); myName=null; checkLoginStatus(); } };

        function updateMainUI() {
            document.getElementById('user-name').innerText = appData.auth[myName].name;
            renderResolutionList(); renderMessages(); renderAdvancedStats(); updateBibleStats();
        }

        /* --- [NEW] ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ ë¡œì§ --- */
        window.openEditModal = function(idx) {
            editIdx = idx;
            const item = appData[myName].resolution[idx];
            document.getElementById('edit-title').value = item.text;
            
            const container = document.getElementById('edit-steps-container');
            container.innerHTML = "";
            item.steps.forEach(step => {
                const div = document.createElement('div');
                div.className = "step-edit-row";
                div.innerHTML = `<input type="text" class="step-edit-input" value="${step}"><button class="btn-remove-step" onclick="this.parentElement.remove()">x</button>`;
                container.appendChild(div);
            });
            
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.addStepInput = function() {
            const div = document.createElement('div');
            div.className = "step-edit-row";
            div.innerHTML = `<input type="text" class="step-edit-input" placeholder="ìƒˆ ë‹¨ê³„"><button class="btn-remove-step" onclick="this.parentElement.remove()">x</button>`;
            document.getElementById('edit-steps-container').appendChild(div);
        };

        window.closeEditModal = function() {
            document.getElementById('edit-modal').classList.add('hidden');
            editIdx = null;
        };

        window.saveEditModal = function() {
            const newTitle = document.getElementById('edit-title').value.trim();
            if(!newTitle) return alert("ëª©í‘œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            const stepInputs = document.querySelectorAll('.step-edit-input');
            const newSteps = [];
            stepInputs.forEach(input => { if(input.value.trim()) newSteps.push(input.value.trim()); });
            if(newSteps.length === 0) newSteps.push("ì™„ë£Œ");

            const item = appData[myName].resolution[editIdx];
            
            // ë‹¨ê³„ê°€ ë°”ë€Œë©´ ì²´í¬ë°•ìŠ¤ ë°°ì—´ ì¬ì¡°ì •
            if(item.steps.length !== newSteps.length) {
                item.done = new Array(newSteps.length).fill(false);
                item.counts = new Array(newSteps.length).fill(0);
            }
            item.text = newTitle;
            item.steps = newSteps;

            saveData().then(() => {
                closeEditModal();
            });
        };

        window.deleteItemFromModal = function() {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                appData[myName].resolution.splice(editIdx, 1);
                saveData().then(() => closeEditModal());
            }
        };
        /* -------------------------------- */

        function renderResolutionList() {
            const list = document.getElementById('list-resolution');
            list.innerHTML = "";
            const myItems = appData[myName].resolution || [];
            
            myItems.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = "resolution-item";
                
                let stepsHtml = "";
                item.steps.forEach((stepName, sIdx) => {
                    const isDone = item.done[sIdx] ? "done" : "";
                    stepsHtml += `<span class="step-item ${isDone}" onclick="window.toggleStep(${idx}, ${sIdx})">${stepName}</span>`;
                });

                li.innerHTML = `
                    <div class="res-left">
                        <div class="res-text">${item.text}</div>
                        <div class="steps">${stepsHtml}</div>
                    </div>
                    <button class="edit-icon-btn" onclick="window.openEditModal(${idx})"><i class="fas fa-pen"></i></button>
                `;
                list.appendChild(li);
            });
        }

        window.addItem = function() {
            const input = document.getElementById('input-resolution');
            if(!input.value.trim()) return;
            // ì´ˆê¸° ì¶”ê°€ëŠ” ê°„ë‹¨í•˜ê²Œ, ìˆ˜ì •ì€ íŒì—…ìœ¼ë¡œ
            if(!appData[myName].resolution) appData[myName].resolution = [];
            appData[myName].resolution.push({ text: input.value.trim(), steps: ["ì™„ë£Œ"], done: [false], counts: [0] });
            input.value = "";
            saveData();
        };

        window.toggleStep = function(itemIdx, stepIdx) {
            const item = appData[myName].resolution[itemIdx];
            item.done[stepIdx] = !item.done[stepIdx];
            if(!item.counts) item.counts = new Array(item.steps.length).fill(0);
            if(item.done[stepIdx]) {
                item.counts[stepIdx]++;
                if(window.confetti) confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            } else {
                item.counts[stepIdx] = Math.max(0, item.counts[stepIdx] - 1);
            }
            
            const today = new Date().toISOString().split('T')[0];
            if(!appData[myName].history) appData[myName].history = {};
            let totalDone = 0;
            appData[myName].resolution.forEach(r => r.done.forEach(d => { if(d) totalDone++; }));
            appData[myName].history[today] = totalDone;
            saveData();
        };

        window.toggleAccordion = function(id) {
            document.getElementById(id).classList.toggle('hidden');
        };

        function renderAdvancedStats() {
            const period = appData.period || { start: "2024-01-01", end: "2024-12-31" };
            document.getElementById('period-display').innerText = `${period.start} ~ ${period.end}`;
            
            // ë­í‚¹
            const activeUsers = USER_SLOTS.filter(u => appData.auth && appData.auth[u]);
            const resRankEl = document.getElementById('rank-resolution'); resRankEl.innerHTML = "";
            activeUsers.map(u => {
                const h = appData[u].history || {};
                let score = 0;
                Object.keys(h).forEach(d => { if(d >= period.start && d <= period.end) score += h[d]; });
                return { name: appData.auth[u].name, val: score };
            }).sort((a,b)=>b.val-a.val).forEach((r,i)=> resRankEl.innerHTML += `<div class="rank-row"><span>${i+1}.${r.name}</span><span class="score">${r.val}ì </span></div>`);

            // ì„±ê²½ë­í‚¹ (ì´ë²ˆì£¼)
            const bibRankEl = document.getElementById('rank-bible'); bibRankEl.innerHTML = "";
            const now=new Date(), day=now.getDay(), diff=day===6?0:day+1;
            const s=new Date(now); s.setDate(now.getDate()-diff); const sStr=s.toISOString().split('T')[0];
            const e=new Date(s); e.setDate(s.getDate()+6); const eStr=e.toISOString().split('T')[0];
            
            activeUsers.map(u => {
                const b = appData[u].bible || {};
                let c = 0;
                Object.values(b).forEach(d => { if(d>=sStr && d<=eStr) c++; });
                return { name: appData.auth[u].name, val: c };
            }).sort((a,b)=>b.val-a.val).forEach((r,i)=> bibRankEl.innerHTML += `<div class="rank-row"><span>${i+1}.${r.name}</span><span class="score">${r.val}ì¥</span></div>`);

            // íˆíŠ¸ë§µ
            const heatGrid = document.getElementById('heatmap-grid'); heatGrid.innerHTML = "";
            const days = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            const today = now.toISOString().split('T')[0];
            const myH = appData[myName].history || {};
            for(let d=1; d<=days; d++) {
                const dStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const val = myH[dStr] || 0;
                const cell = document.createElement('div'); cell.className = "heat-day";
                if(val>0) cell.classList.add(val>5?"level-3":val>2?"level-2":"level-1");
                if(dStr===today) cell.classList.add("today");
                cell.innerText = d;
                heatGrid.appendChild(cell);
            }

            // ëª©í‘œë³„ ë‹¬ì„±ë„
            const goalList = document.getElementById('goal-breakdown-list'); goalList.innerHTML = "";
            (appData[myName].resolution||[]).forEach(g => {
               const t = (g.counts||[]).reduce((a,b)=>a+b,0);
               goalList.innerHTML += `<div class="goal-stat-item"><div class="goal-label-row"><span class="goal-name">${g.text}</span><span class="goal-percent">${t}íšŒ</span></div><div class="progress-bg"><div class="progress-bar" style="width:${Math.min(100,t*2)}%"></div></div></div>`;
            });

            // ëª…ì˜ˆì˜ ì „ë‹¹
            const hallList = document.getElementById('hall-of-fame-list'); hallList.innerHTML = "";
            (appData.pastSeasons||[]).reverse().forEach(p => {
                hallList.innerHTML += `<div class="fame-row"><div class="fame-season">${p.range}</div><div class="fame-winner">ğŸ‘‘ ${p.winner} (${p.score})</div></div>`;
            });
        }

        window.manageSeason = function() {
            const c = appData.period;
            if(!confirm(`ì‹œì¦Œ(${c.start}~${c.end})ì„ ë§ˆê°í•˜ê³  ìš°ìŠ¹ìë¥¼ ê¸°ë¡í• ê¹Œìš”?`)) {
                const ns = prompt("ì‹œì‘ì¼ ìˆ˜ì •", c.start); if(ns) appData.period.start = ns;
                const ne = prompt("ì¢…ë£Œì¼ ìˆ˜ì •", c.end); if(ne) appData.period.end = ne;
                saveData(); return;
            }
            const users = USER_SLOTS.filter(u=>appData.auth&&appData.auth[u]);
            const rank = users.map(u => {
                const h = appData[u].history||{};
                let s = 0; Object.keys(h).forEach(d=>{if(d>=c.start&&d<=c.end)s+=h[d]});
                return {name:appData.auth[u].name, val:s};
            }).sort((a,b)=>b.val-a.val);
            
            if(!appData.pastSeasons) appData.pastSeasons=[];
            appData.pastSeasons.push({range:`${c.start}~${c.end}`, winner:rank[0].name, score:rank[0].val});
            
            const nextS = prompt("ìƒˆ ì‹œì¦Œ ì‹œì‘ì¼:", new Date().toISOString().split('T')[0]);
            const nextE = prompt("ìƒˆ ì‹œì¦Œ ì¢…ë£Œì¼:", "2024-12-31");
            appData.period = {start:nextS, end:nextE};
            saveData().then(()=>alert("ì‹œì¦Œ ë§ˆê° ì™„ë£Œ!"));
        }

        /* ì„±ê²½ ë¡œì§ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼) */
        function updateBibleStats() {
            const today=new Date().toISOString().split('T')[0], y=new Date().getFullYear().toString();
            const b=appData[myName].bible||{};
            let tC=0, yC=0;
            Object.values(b).forEach(d=>{if(d===today)tC++; if(d.startsWith(y))yC++;});
            document.getElementById('bible-today-count').innerText = `+${tC}ì¥`;
            document.getElementById('bible-year-count').innerText = `${yC}ì¥`;
        }
        window.showBibleBooks=(t)=>{bibleState.currentTestament=t; document.getElementById('bible-main-view').classList.add('hidden-view'); document.getElementById('bible-books-view').classList.remove('hidden-view'); const g=document.getElementById('bible-books-grid'); g.innerHTML=""; BIBLE_DATA.books.filter(b=>b.testament===t).forEach(b=>{const d=document.createElement('div'); d.className="bible-btn"; let rc=0; for(let i=1;i<=b.chapters;i++){const k=`${b.name}-${i}`; if(appData[myName].bible&&appData[myName].bible[k])rc++;} if(rc>=b.chapters)d.classList.add('completed'); d.innerText=b.name; d.onclick=()=>showChapters(b); g.appendChild(d);});};
        function showChapters(b){bibleState.currentBook=b.name; document.getElementById('bible-books-view').classList.add('hidden-view'); document.getElementById('bible-chapters-view').classList.remove('hidden-view'); document.getElementById('bible-book-title').innerText=b.name; renderChaptersGrid();}
        function renderChaptersGrid(){const b=BIBLE_DATA.books.find(x=>x.name===bibleState.currentBook); const g=document.getElementById('bible-chapters-grid'); g.innerHTML=""; let all=true; for(let i=1;i<=b.chapters;i++){const d=document.createElement('div'); d.className="chapter-item"; const k=`${b.name}-${i}`; const r=appData[myName].bible&&appData[myName].bible[k]; if(r)d.classList.add('checked'); else all=false; d.innerText=i; d.onclick=()=>window.toggleChapter(k,!r); g.appendChild(d);} const btn=document.getElementById('btn-finish-book'); if(all){btn.classList.remove('disabled'); btn.innerText="ì´ ì±… ì™„ë…í•˜ê¸° ğŸ‰";}else{btn.classList.add('disabled'); btn.innerText="ëª¨ë‘ ì½ì–´ì•¼ ì™„ë… ê°€ëŠ¥";}}
        window.toggleChapter=(k,c)=>{if(!appData[myName].bible)appData[myName].bible={}; if(c)appData[myName].bible[k]=new Date().toISOString().split('T')[0]; else delete appData[myName].bible[k]; saveData().then(()=>renderChaptersGrid());};
        window.controlAll=(on)=>{const b=BIBLE_DATA.books.find(x=>x.name===bibleState.currentBook); if(!appData[myName].bible)appData[myName].bible={}; const t=new Date().toISOString().split('T')[0]; for(let i=1;i<=b.chapters;i++){const k=`${b.name}-${i}`; if(on)appData[myName].bible[k]=t; else delete appData[myName].bible[k];} saveData().then(()=>renderChaptersGrid());};
        window.finishBookAndReset=()=>{const btn=document.getElementById('btn-finish-book'); if(btn.classList.contains('disabled'))return; if(confirm("ì™„ë… ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { if(!appData[myName].bibleRounds)appData[myName].bibleRounds={}; const b=bibleState.currentBook; appData[myName].bibleRounds[b]=(appData[myName].bibleRounds[b]||0)+1; window.controlAll(false); }};
        window.backToBooks=()=>{document.getElementById('bible-chapters-view').classList.add('hidden-view'); document.getElementById('bible-books-view').classList.remove('hidden-view');};
        window.showBibleMain=()=>{document.getElementById('bible-books-view').classList.add('hidden-view'); document.getElementById('bible-main-view').classList.remove('hidden-view');};

        /* ì±„íŒ… & ê¸°íƒ€ */
        window.sendMsg=()=>{const i=document.getElementById('input-msg'); if(!i.value.trim())return; if(!appData.messages)appData.messages=[]; appData.messages.push({sender:appData.auth[myName].name, text:i.value.trim()}); if(appData.messages.length>50)appData.messages.shift(); i.value=""; saveData();};
        function renderMessages(){const l=document.getElementById('msg-list'); l.innerHTML=""; [...(appData.messages||[])].reverse().forEach(m=>{const li=document.createElement('li'); li.innerHTML=`<b>${m.sender}:</b> ${m.text}`; l.appendChild(li);});}
        window.saveAlarmTime=()=>{alert("ì•ŒëŒ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘ ğŸ””");};
        window.goTab=(t,b)=>{document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); b.classList.add('active'); document.querySelectorAll('.page').forEach(e=>e.classList.add('hidden')); document.getElementById('page-'+t).classList.remove('hidden'); if(t==='stats')renderAdvancedStats(); if(t==='bible')updateBibleStats();};

        async function saveData() { try { await setDoc(docRef, { appData: appData }, { merge: true }); updateMainUI(); } catch(e) { console.error(e); } }
        function initNewData() { const y=new Date().getFullYear(); appData={auth:{}, messages:[], period:{start:`${y}-01-01`, end:`${y}-12-31`}}; saveData(); }

        startApp();
    </script>
</body>
</html>
